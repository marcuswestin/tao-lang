set unstable := true
set fallback := true
# set quiet := true

dev:
    cursor --extensionDevelopmentPath .

run:
    echo
    echo "\tBuild and package extension..."
    just package
    echo "\tInstall extension..."
    just uninstall-extension > /dev/null 2>&1 || true
    just install-extension > /dev/null 
    echo "\tCheck extension installation..."
    set -e && cursor --list-extensions | grep "tao.tao-lang-vscode-extension" || { echo "Installation failed -- extension not found" >&2; exit 1; }
    echo "\n\t* Extension installed - restart IDE *\n"
    # just restart-cursor
    echo "\tCheck for type errors..."
    # just check

# Package the extension. This calls `just _npm-package-script_vscode-prepublish` via package.json script `vscode:prepublish`.
package:
    bunx @vscode/vsce package --allow-missing-repository --out ../../.builds 1> /dev/null

_npm-package-script_vscode-prepublish:
    node esbuild.mjs

package-and-install:
    just package
    just install-extension

uninstall-extension:
    cursor --uninstall-extension tao.tao-lang-vscode-extension

install-extension:
    cursor --install-extension ../../.builds/tao-lang-vscode-extension-0.0.1.vsix --verbose --force

restart-cursor:
    osascript -e 'quit app "Cursor"'
    sleep 0.25 && open -a Cursor && sleep 0.5 && open -a Cursor && sleep 0.5 && open -a Cursor

build: _install_deps
    cd ../compiler && just build
    node esbuild.mjs

check:
    tsc -b tsconfig.json

_install_deps:
    bun install
